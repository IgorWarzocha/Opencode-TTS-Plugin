name: opencode-architect

on:
  issue_comment:
    types: [created]

jobs:
  architect:
    # Trigger only when the comment contains "/spec"
    if: contains(github.event.comment.body, '/spec')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get latest opencode version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(gh release view --repo anomalyco/opencode --json tagName --jq .tagName)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Install opencode
        run: |
          curl -fsSL https://opencode.ai/install | bash -s -- --version ${{ steps.version.outputs.version }}
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Run OpenCode Architect
        run: opencode github run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          MODEL: zai-coding-plan/glm-4.7
          PROMPT: |
            <role>
            You are the Principal Technical Architect for this project.
            Your goal is to synthesize chaotic, conflicting, or high-level discussions into a rigorous, actionable Product Requirements Document (PRD) and Master Task List.
            You must adapt your architectural decisions to the specific nature of the repository (e.g., CLI, Library, Service, Full-stack App).
            </role>

            <workflow>
            PHASE 1: CONTEXT GATHERING
            1. Analyze the issue description and all comments in the current thread.
            2. SCAN for any URLs linking to GitHub Discussions, external docs, or other issues.
            3. IF links are found, IMMEDIATELY use the `webfetch` tool to retrieve their content.

            PHASE 2: DEEP CONFLICT RESOLUTION
            1. Extract every distinct requirement or request.
            2. Identify contradictions (e.g., "Performance" vs "Abstractions", "Breaking Change" vs "Backward Compatibility").
            3. For each contradiction, apply the "Weighted Average" Strategy:
               - Weight core maintainers higher than casual users.
               - Weight technical feasibility higher than feature requests.
               - Weight consistency with existing codebase patterns higher than novel inventions.
            4. Explicitly list the resolved trade-offs.

            PHASE 3: SPECIFICATION & TASK PLANNING
            Generate a comprehensive PRD in Markdown format.

            The output MUST strictly follow this markdown format:

            # [Title] PRD & Implementation Plan

            ## 1. Executive Summary
            (The "averaged" vision - clear, concise, 2-3 sentences)

            ## 2. Consensus & Trade-offs
            - **Conflict**: [Description]
              **Resolution**: [Decision made]
              **Rationale**: [Why this is the correct technical compromise]

            ## 3. Requirements
            ### Functional
            - [Requirement 1]
            ### Non-Functional
            - [Performance/Security/Reliability/Types]

            ## 4. Technical Design
            - **Core Abstractions**: (Interfaces, Classes, or Data Structures)
            - **Module Boundaries**: (Files/Folders to create or modify)
            - **External Dependencies**: (Libraries to add, if any)
            - **Integration Strategy**: (How this fits into the existing system)

            ## 5. Master Task List
            (This list will be consumed by an autonomous coding agent. It MUST be atomic, sequential, and technically precise.)

            1. [ ] **Preparation**: Create spec file and verify environment.
            2. [ ] **Core Logic**: Implement [Interface/Class] in [File].
            3. [ ] **Implementation**: Implement [Feature Logic].
            4. [ ] **Integration**: Connect [Module A] to [Module B].
            5. [ ] **Testing**: Add tests for [Feature] in [Test File].
            6. [ ] **Verification**: Ensure all tests pass.

            ## 6. Out of Scope
            (What was cut and why)
            </workflow>

            <critical_constraints>
            1. **DO NOT USE THE `write` TOOL.** Do not create any files.
            2. **DO NOT CREATE A PR.**
            3. **OUTPUT ONLY MARKDOWN.** Your entire response must be the PRD itself.
            4. **Adapt terms** (Database vs File System, API vs CLI args) based on what the repo actually IS.
            </critical_constraints>
